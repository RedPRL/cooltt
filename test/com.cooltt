def mycoe/fun : {
  (A : (i : dim) -> univ) (B : (i: dim) -> univ)
  (coe/A : (r : dim) (x : A r) (i : dim) -> sub {A i} {i=r} x)
  (coe/B : (r : dim) (x : B r) (i : dim) -> sub {B i} {i=r} x)
  (r : dim) (f : (_ : A r) -> B r) (i : dim) ->
  sub {(_ : A i) -> B i} {i=r} f
} = {
 \A B coe/A coe/B r f i x =>
 coe/B r {f {coe/A i x r}} i
}

def mycom/fun : {
  (A : dim -> univ)
  (B : dim -> univ)
  (com/A : (r : dim) (φ : cof) (p : (i : dim) (_ : [i=r \/ φ]) -> A i) (i : dim) -> sub {A i} {i=r \/ φ} {p i _})
  (com/B : (r : dim) (φ : cof) (p : (i : dim) (_ : [i=r \/ φ]) -> B i) (i : dim) -> sub {B i} {i=r \/ φ} {p i _})
  (r : dim) (φ : cof) (p : (i : dim) (_ : [i=r \/ φ]) (_ : A i) -> B i) (i : dim) -> sub {(_ : A i) -> B i} {i=r \/ φ} {p i _}
} = {
  \A B com/A com/B r φ p r' x =>
  com/B r φ {\j _ => p j _ {com/A r' #f {\_ _ => x} j}} r'
}

normalize mycom/fun

def coe/intro : {
  (A : dim -> univ) (r : dim) (r' : dim) (x : A r) ->
  sub {A r'} {r=r'} x
} = {
 \A r r' x => coe A r r' x
}

def coe/pi : {
  (A : dim -> univ) (B : (i : dim) -> A i -> univ)
  (r : dim) (r' : dim)
  (f : (x : A r) -> B r x) ->
  sub {(x : A r') -> B r' x} #t {\x => coe {\i => B i {coe A r' i x}} r r' {f {coe A r' r x}}}
} = {
 \A B r r' f =>
 coe {\i => (x : A i) -> B i x} r r' f
}

normalize coe/pi

def coe/sigma : {
  (A : dim -> univ) (B : (i : dim) -> A i -> univ)
  (r : dim) (r' : dim)
  (p : (x : A r) * B r x) ->
  sub {(x : A r') * B r' x} #t [coe A r r' {fst p}, coe {\i => B i {coe A r i {fst p}}} r r' {snd p}]
} = {
  \A B r r' p =>
  coe {\i => (x : A i) * B i x} r r' p
}

normalize coe/sigma

def coe/path : {
  (A : dim -> univ) (B : (i : dim) -> A i -> univ)
  (r : dim) (s : dim)
  (bdry : ?)
  (m : A r)
  -> sub {A s} {r = s} [?]
} = {
  \A B r s bdry m =>
  coe {\i => Path A bdry} r s m
}

normalize coe/path

def hcom/intro : {
  (A : univ) (r : dim) (r' : dim) (φ : cof)
  (p : (i : dim) (_ : [i=r \/ φ]) -> A) ->
  sub A {r=r' \/ φ} {p r' _}
} = {
  \A r r' φ p =>
  hcom A r r' φ p
}

def hcom/fun : {
  (A : univ) (B : univ) (r : dim) (r' : dim) (φ : cof)
  (p : (i : dim) (_ : [i=r \/ φ]) -> A -> B) ->
  sub {A -> B} {0=0} {\x => hcom B r r' φ {\j _ => p j _ x}}
} = {
  \A B r r' φ p =>
  hcom {A -> B} r r' φ p
}

normalize hcom/fun

def com/intro : {
  (A : dim -> univ) (r : dim) (r' : dim) (φ : cof)
  (p : (i : dim) (_ : [i=r \/ φ]) -> A i) ->
  sub {A r'} {r=r' \/ φ} {p r' _}
} = {
  \A r r' φ p =>
  com A r r' φ p
}

normalize com/intro

def com/decomposition : {
  (A : dim -> univ) (r : dim) (r' : dim) (φ : cof)
  (p : (i : dim) (_ : [i=r \/ φ]) -> A i) ->
  sub {A r'} #t {hcom {A r'} r r' φ {\j _ => coe A j r' {p j _}}}
} = {
  \A r r' φ p =>
  com A r r' φ p
}
